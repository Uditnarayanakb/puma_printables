databaseChangeLog:
  - changeSet:
      id: 004-extend-users-auth
      author: github-copilot
      changes:
        - addColumn:
            tableName: users
            columns:
              - column:
                  name: auth_provider
                  type: VARCHAR(20)
                  defaultValue: LOCAL
                  constraints:
                    nullable: false
              - column:
                  name: provider_subject
                  type: VARCHAR(100)
              - column:
                  name: full_name
                  type: VARCHAR(150)
              - column:
                  name: avatar_url
                  type: VARCHAR(255)
              - column:
                  name: first_login_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: last_login_at
                  type: TIMESTAMP WITH TIME ZONE
              - column:
                  name: login_count
                  type: INTEGER
                  defaultValueNumeric: 0
                  constraints:
                    nullable: false
        - addUniqueConstraint:
            tableName: users
            columnNames: auth_provider, provider_subject
            constraintName: uq_users_provider_subject
        - sql:
            stripComments: true
            sql: |
              UPDATE users
              SET auth_provider = 'LOCAL',
                  login_count = COALESCE(login_count, 0)
              WHERE auth_provider IS NULL;
